> * æ ‡ç­¾ï¼šKotlinã€JavaScriptã€å‰ç«¯

# è‡ªå·±æ„å»ºä¸€ä¸ªåšå®¢ç³»ç»Ÿï½œé¡¹ç›®å¤ç›˜

## ä¸ºç¥é©¬è¦æè¿™ä¸ª

æœ€è¿‘å‚ä¸äº†æ˜é‡‘çš„ç¿»è¯‘è®¡åˆ’ï¼Œäº§å‡ºäº†å¤§é‡çš„ Markdown æ–‡ç« ï¼Œå¸Œæœ›æ­å»ºä¸€ä¸ªä¸ªäººç«™ï¼Œå­˜æ”¾è‡ªå·±çš„ä¸€äº›æ–‡ç« ï½

çœ‹äº†ä¸€äº›ç°æˆçš„è§£å†³æ–¹æ¡ˆï¼Œæ„Ÿè§‰å±€é™æ€§å¤ªå¤šï¼Œä¸åˆ©äºåæœŸè‡ªå®šä¹‰ï¼Œå†åŠ ä¸Šæˆ‘è¿™ä¸ªè¶…çº§å–œæ¬¢é€ è½®å­çš„æ€§æ ¼ï¼Œäºæ˜¯ä¹ ğŸ‘€

![](../images/blog-review.md-c7798e9279b942c4a4e9e38a7b461250~tplv-k3u1fbpfcp-watermark.image)

### æˆ‘å°±æ­å»ºäº†ä¸€ä¸ªè‡ªå·±çš„å¤„ç†ç³»ç»Ÿ

åˆ«é—®æˆ‘ä¸ºå•¥è¿™æ ·åšï¼Œæˆ‘è§‰å¾—å¥½ç©ï¼ˆï¼Œè€Œä¸”è‡ªå®šä¹‰èƒ½åŠ›è¶…å¼ºï¼Œå¯ä»¥éšæ„åŠ æ§ä»¶ï¼ï¼ï¼


[<img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/67c7b9be335b41a4818643ac7a33f588~tplv-k3u1fbpfcp-watermark.image" width="360px" />](https://github.com/PassionPenguin/passionpenguin.github.io/)

## éœ€æ±‚åŠŸèƒ½

* æ¸²æŸ“ Markdown æ ‡è®°
* è‡ªå®šä¹‰é¡µé¢
* åæœŸå¯ä»¥ç®€å•çš„å¯¹æ‰€æœ‰æ–‡ç« é¡µé¢ä½œæ›´æ–°
* ä¾¿äºç§»æ¤

### æœ¬æ¬¡ä½¿ç”¨çš„å·¥å…·æœ‰ï¼š

#### å‰ç«¯éƒ¨åˆ†

åŸºç¡€çš„å‰ç«¯é¡µé¢æ„é€ ä½¿ç”¨äº†åŸç”Ÿ Vanilla JavaScript + CSS + HTMLï¼Œæ„é€ ä¸€ä¸ªé™æ€çš„æ–‡ç« å±•ç¤ºç³»ç»Ÿã€‚

<img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/752532eed7324e869f9be889bda9cfa8~tplv-k3u1fbpfcp-watermark.image" alt="HTML CSS JS" width="640px" />

åœ¨æ ·å¼æ–¹é¢ä½¿ç”¨äº† SCSS è¯­è¨€ï¼Œå¹¶ä¸”é¡ºå¸¦ä½¿ç”¨äº† GitHub çš„ä¸»é¢˜ `@primer` åº“ï¼Œå¹¶é¡ºå¸¦é­”æ”¹äº†ä¸€ç•ªï½

<img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c0f40b5ac72840338aaf4d7bdcee2b77~tplv-k3u1fbpfcp-watermark.image" alt="SCSS" width="240px" />

#### åç«¯éƒ¨åˆ†

åœ¨æ–‡ç« å¤„ç†ï¼ˆæ ‡ç­¾è·å–ã€å›¾ç‰‡çˆ¬å–ï¼‰ä¸Šä½¿ç”¨äº† Java + Kotlin çš„ç»„åˆï¼Œä¸»è¦æ˜¯æˆ‘å¯¹ Kotlin æŒºç†Ÿçš„ï¼Œæ¯•ç«Ÿåšäº†ä¸€å¹´ Kotlin é¡¹ç›®äº† = =ã€‚

![](../images/blog-review.md-887cbf9766fa44ffa1bbe9e0c9de9eb5~tplv-k3u1fbpfcp-watermark.image)

![](../images/blog-review.md-3d4156bd11d9450b936181d989fe3453~tplv-k3u1fbpfcp-watermark.image)

## æ„å»ºæ€è·¯

### åç«¯å¤„ç†

#### å…ƒæ•°æ®å¤„ç†

Java ä¸»è¦å¤„ç†å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬æ–‡ç« çš„æ ‡ç­¾ï¼ˆåˆ†ç±»ï¼‰çš„è¯»å–ï¼Œæ–‡ç« å›¾ç‰‡çš„è§£æçˆ¬å–ï¼Œä»¥åŠæ–‡ç« æ ‡é¢˜ç®€ä»‹ç­‰ä¿¡æ¯çš„è¯»å–ï¼Œå…·ä½“æ€è·¯å¦‚ä¸‹ï¼š

```mermaid
sequenceDiagram
    participant z as Markdown æ–‡ä»¶
    participant l as JSON æ–‡ä»¶
    loop å¤„ç†æ•°æ®
        z->>l: æ˜¯å¦å­˜åœ¨ è¿œç¨‹ å›¾ç‰‡
        activate z
        alt æœ‰
            l->>z: ä¸‹è½½
        else æ²¡æœ‰
            l->>z: è·³è¿‡
        end
        z->>l: æ˜¯å¦å·²ç»æœ‰æ ‡ç­¾æ•°æ®
        activate z
        alt æœ‰
            l->>z: è·³è¿‡
        else æ²¡æœ‰
            l->>z: åŠ è½½æ•°æ®ï¼ˆGitHub / æœ¬åœ°ï¼‰
        end
    end
```

å…ˆçœ‹ä¸€ä¸‹æ¨¡ç‰ˆå†…å®¹ï¼Œé»˜è®¤æ¨¡ç‰ˆï¼š

```markdown
> * æ ‡ç­¾ï¼šæ ‡ç­¾ Aã€æ ‡ç­¾ B

# æ ‡é¢˜
```

ç¿»è¯‘æ¨¡ç‰ˆï¼š

```markdown
> * åŸæ–‡åœ°å€ï¼š[]()
> * åŸæ–‡ä½œè€…ï¼š[]()
> * è¯‘æ–‡å‡ºè‡ªï¼š[æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)
> * æœ¬æ–‡æ°¸ä¹…é“¾æ¥ï¼š[https://github.com/xitu/gold-miner/blob/master/article/2021/.md](https://github.com/xitu/gold-miner/blob/master/article/2021/.md)
> * è¯‘è€…ï¼š
> * æ ¡å¯¹è€…ï¼š

# æ ‡é¢˜
```

---

è¿™é‡Œçš„æ‰€æœ‰çš„ä»£ç éƒ½ä¿å­˜åœ¨äº†è¿™é‡Œï¼š[PassionPenguin:PageGenerator/io.hoarfroster](https://github.com/PassionPenguin/PageGenerator/tree/master/src/main/kotlin/io/hoarfroster)ï¼Œé¦–å…ˆæ˜¯å®ç°è·å–æ‰€æœ‰æ–‡ä»¶ï¼š

```kotlin
fun main(args: Array<String>) {
    var downloadImage = false
    var inputDir: String? = null

    for (name in args) {
        if (name.contains(Regex("--input=(.+?)")))
            inputDir = name.substring(8)
    }
    if (inputDir == null)
        return

    val dir = File("${inputDir}/documents/")
    val files = dir.listFiles { _, name -> name.endsWith(".md") }
}
```

ç„¶åä½¿ç”¨ `mapIndexed` éå†æ‰€æœ‰ Markdown æ–‡ä»¶ï¼Œè¯»å–æ–‡ä»¶ï¼š

```kotlin
files?.mapIndexed { index, it -> 
    var sourceMarkdown = it.readText()
    val document = Jsoup.parse(HtmlRenderer.builder().build().render(Parser.builder().build().parse(sourceMarkdown)))
}
```

è¿™é‡Œä½¿ç”¨äº† `commonmark` å’Œ `Jsoup` è§£æäº† Markdown æ–‡ä»¶ä¸º HTML æ–‡ä»¶ï¼ˆå…¶å®ä¹Ÿå¯ä»¥ä¸ç”¨ï¼Œå…¨æ–‡æ­£åˆ™åŒ¹é…ï¼Œä½†æ„Ÿè§‰è¿˜æ˜¯æœ‰äº›éº»çƒ¦ï¼‰ã€‚

æˆ‘ä»¬éœ€è¦çš„ä¿¡æ¯æœ‰ï¼š

* æ ‡é¢˜
* æ ‡ç­¾
* ç®€ä»‹
* æ–‡ä»¶å
* æœ€åä¿®æ”¹æ—¶é—´
* ï¼ˆè¿œç¨‹é“¾æ¥ï¼‰
* ï¼ˆè¯‘è€…ï¼‰

##### æ ‡é¢˜

```kotlin
document.selectFirst("h1").text()
```

##### æ ‡ç­¾

1. GitHub æ ‡ç­¾

æ€è·¯å¾ˆç®€å•ï¼Œç›´æ¥ç”¨ URLConnection è¯»å–æ•°æ®å¹¶è§£æå°±å¥½äº†ï¼š

```kotlin
package io.hoarfroster

import org.jsoup.Jsoup
import java.net.URL
import javax.net.ssl.HttpsURLConnection

class RetrieveResult(val tags: MutableList<Tag>)

fun retrieveResult(repoUrl: String): RetrieveResult {
    println(" - Processing tags data")
    val tags: MutableList<Tag> = mutableListOf()
    val connection = URL(repoUrl.replace("blob", "commits").replace(" ", "%20")).openConnection() as HttpsURLConnection
    val document = Jsoup.parse(connection.inputStream.bufferedReader().readText())
    document.select("[data-hovercard-type=\"pull_request\"][data-url].issue-link.js-issue-link")
        .filter { e ->
            Regex("#([0-9]+?)$").matches(e.html())
        }.map { e ->
            Regex("#([0-9]+?)$").find(e.html())?.groupValues?.get(1)
        }.forEach { it ->
            Thread.sleep(1000)
            val conn = URL("https://github.com/xitu/gold-miner/pull/$it").openConnection() as HttpsURLConnection
            val doc = Jsoup.parse(conn.inputStream.bufferedReader().readText())
            if (doc.select(".js-issue-labels > *").size > 0
                && doc.selectFirst(".js-issue-labels").text().contains("ç¿»è¯‘å®Œæˆ")
            ) {
                doc.select(".js-issue-labels > *").forEach {
                    if(!it.text().contains("ç¿»è¯‘å®Œæˆ"))
                        tags.add(Tag(it.text()))
                }
            }
        }
    return RetrieveResult(tags = tags)
}
```

2. æ–‡å†…æ ‡ç­¾

æ›´ç®€å•äº†ï¼Œç›´æ¥ RegExï¼š

```kotlin
val tags = mutableListOf<Tag>()
Regex("æ ‡ç­¾ï¼š(.+?)\n").find(sourceMarkdown)?.groupValues?.get(1)?.split("ã€")?.forEach {
    tags.add(Tag(it))
}
```

##### ç®€ä»‹

ç›´æ¥è¯»å–ç¬¬ä¸€æ®µæ–‡å­—å†…å®¹ï¼Œå½“ä½œç®€ä»‹å†…å®¹ï¼š

```kotlin
var description = ""
for (e in document.select("p")) {
    if (e.text().isNotBlank()) {
        description = e.text()
        break
    }
}
```

##### æ–‡ä»¶å

```kotlin
it.path.replace("${inputDir}/documents/", "")
```

##### æœ€åä¿®æ”¹æ—¶é—´

```kotlin
Date(it.lastModified()).toString()
```

##### ï¼ˆè¿œç¨‹é“¾æ¥ï¼‰

```kotlin
Regex("æœ¬æ–‡æ°¸ä¹…é“¾æ¥ï¼š\\[.+?]\\((.+?)\\)").find(sourceMarkdown)?.groupValues?.get(1) ?: ""
```

##### ï¼ˆè¯‘è€…ï¼‰

```kotln
Regex("è¯‘è€…ï¼š\\[(.+?)]").find(sourceMarkdown)?.groupValues?.get(1) ?: ""
```

#### å›¾ç‰‡ä¸‹è½½

æŒºç®€å•çš„ = =ï¼š

```kotlin
println(" - Processing image")
document.select("img").forEach { img ->
    /* Download external resources */
    val alt = img.attr("alt")
    val urlString = img.attr("src")

    with(
        File(
        "${inputDir}/images/${it.path.replace("${inputDir}/documents/","")
            }-${urlString.getLastSegment()}"
        )
    ) {
        /* Only download the image if the file is not existed */
        if ((!this.isFile || !this.exists()) && !urlString.startsWith("../images/")) {
            Thread.sleep(1000)
            println("   - Processing image $urlString")
            if (!this.parentFile.isDirectory || this.parentFile.exists())
                this.parentFile.mkdirs()
            this.createNewFile()
            val imageUrlConn = URL(urlString).openConnection()
            imageUrlConn.setRequestProperty("referer", URL(urlString).host)
            imageUrlConn.setRequestProperty(
                "user-agent",
                "Mozilla/5.0 (Macintosh; Intel Mac OS X 11_1_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.182 Safari/537.36"
            )
            imageUrlConn.setRequestProperty("origin", "https://www.medium.com/")

            val `in`: InputStream = BufferedInputStream(imageUrlConn.getInputStream())

            val out = ByteArrayOutputStream()
            val buf = ByteArray(1024)
            var n: Int
            while (-1 != `in`.read(buf).also { n = it }) {
                out.write(buf, 0, n)
            }
            out.close()
            `in`.close()
            val response = out.toByteArray()
            this.outputStream().write(response)
            sourceMarkdown = sourceMarkdown.replace(
                """![$alt]($urlString)""",
                """![$alt](../images/${
                    it.path.replace(
            "${inputDir}/documents/",
            ""
                    )
                }-${urlString.getLastSegment()})"""
            )
            it.writeText(sourceMarkdown)
        }
    }
}
```

ç„¶åæ¯æ¬¡è¿è¡Œçš„æ—¶å€™ï¼Œç›´æ¥æ‰§è¡Œï¼š

* /Users/penguin/Desktop/PageGenerator/build/libs/PageGenerator.jarï¼šGradle ç”Ÿæˆçš„ JAR æ–‡ä»¶
* /Library/WebServer/Documentsï¼šæ–‡ä»¶ä»“åº“

```shell
java -jar /Users/penguin/Desktop/PageGenerator/build/libs/PageGenerator.jar --input=/Library/WebServer/Documents/ --downloadImage
```

#### ç”Ÿæˆ HTML æ–‡ä»¶ï¼š

ç»§ç»­é­”æ”¹äº† `markdown-it` åº“ï¼Œå…³é”®ä»£ç æŒºç®€å•çš„ï¼š

```js
exports.render = async (config) => {
  const mdFilePath = path.resolve(config.cwd, config['mdFile'])
  let renderContent = md.render(fse.readFileSync(mdFilePath, 'utf-8'))
  let parser = new DOMParser()
  let document = parser.parseFromString(renderContent, 'text/html')
  let title = document.getElementsByTagName('h1')[0].textContent
  let html = `<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>${title} - Hoarfroster</title>
    <link rel="stylesheet" href="/assets/styles/post.css">
    <link rel="stylesheet"
      href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.5.0/build/styles/atom-one-light.min.css">
</head>
<body>
<div class="container post markdown-body">${renderContent}</div>
<div class="footer"></div>
</body>
<script src="/assets/scripts/index.js"></script>
<script>init()</script>
</html>
`
  config.out = path.resolve(config.cwd, config.out)
  const fileReg = /([^/\\]*)\.[^/\\]+$/
  if (!config.out.match(fileReg)) {
    // if no file suffix, use the same as markdown file
    config.out = path.resolve(
      config.out,
      mdFilePath.match(fileReg)[1] + '.html'
    )
  }
  fse.writeFileSync(config.out, html)
}
```

### å‰ç«¯éƒ¨åˆ†

è¿™é‡Œé‡åˆ°äº†ä¸€ä¸ªè¶…çº§å¤§çš„å‘ï¼Œå³ GitHub çš„æ ·å¼å’Œ `@primer` åº“çš„å†…å®¹å®Œå…¨ä¸ä¸€æ ·ï¼äºæ˜¯ä¹æˆ‘è¢«è¿«æ§åˆ¶å°æŠ„äº†å‡ åƒè¡Œçš„ CSS é¢œè‰²å˜é‡ï¼š

![ .png](../images/blog-review.md-9ee3d640ea4c4069b86855811642e0bb~tplv-k3u1fbpfcp-watermark.image)

ç»“æœ GitHub æœ€è¿‘åˆæ¨äº†æ–°çš„ä¸»é¢˜ï¼Œè¿™æ˜¯è¦æ¦¨å¹²ä¼é¹…å˜› = =ã€‚

æœ€åä½¿ç”¨äº† JavaScript ä¸ºæ¯ä¸€ç¯‡æ–‡ç« åŠ ä¸Š Header ä»¥åŠ Footerï¼š

![Screen Shot 2021-03-18 at 10.31.33 PM.png](../images/blog-review.md-c3994e529946467c9b68232ae11bdc17~tplv-k3u1fbpfcp-watermark.image)

## å½“å‰æ•ˆæœ

### ä¸»é¡µ

![gh.hoarfroster.space_.png](../images/blog-review.md-1736ba3f839441a19bb0874a7adefc11~tplv-k3u1fbpfcp-watermark.image)

### 404 Not Found

![gh.hoarfroster.space_404.png](../images/blog-review.md-b212c1f946424abe9d231f025cf6e3ff~tplv-k3u1fbpfcp-watermark.image)

### About

![gh.hoarfroster.space_about.html.png](../images/blog-review.md-996cc67b25af46df98a092b369a04643~tplv-k3u1fbpfcp-watermark.image)

### æ­£æ–‡å†…å®¹

![gh.hoarfroster.space_archive_messengers-like-imageview.html.png](../images/blog-review.md-2e694e71557b4018957ff4ffc9b58e3b~tplv-k3u1fbpfcp-watermark.image)

## GitHub CI

```yaml
name: Page Automator

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Set up JDK 1.8
        uses: actions/setup-java@v1
        with:
          java-version: 1.8

      - name: Use Node.js 15.x
        uses: actions/setup-node@v1
        with:
          node-version: 15.x

      - name: setup git config
        run: |
          git config --global user.name "Hoarfroster Bot"
          git config --global user.email "<penguin.zhang@qq.com>"

      - uses: actions/checkout@master
        with:
          repository: PassionPenguin/PageGenerator
          path: ./page-generator

      - uses: actions/checkout@master
        with:
          path: ./documents

      - name: Build with Gradle
        run: |
          cd ./page-generator
          ./gradlew build

      - name: Generate Structure
        run: |
          echo "Processing Markdown Files"
          java -jar page-generator/build/libs/PageGenerator.jar --input=./documents
          cd ./documents

          git add *
          if [[ -n $(git status -uno --porcelain) ]]
          then
            git commit -m "Generate Structure"
            git push origin master
          fi

      - name: NPM Install
        run: |
          npm i -g markdown-html-gen

      - name: Generate HTML Pages with Markdown Files
        run: |
          echo "Generating HTML Files"
          cd ./documents
          for f in documents/*.md
            do
              htmlpath=${f/documents/archive}
              htmlpath=${htmlpath/md/html}
              md2html "$f" -o ./archive
              echo " - Generated $htmlpath"
            done

          git add *
          if [[ -n $(git status -uno --porcelain) ]]
          then
            git commit -m "Build Pages"
            git push origin master
          fi
```

## åæ€ä¸æ€»ç»“

å°è¯•å€’æ˜¯ä¸é”™ï¼Œä¸è¿‡è¿˜æœ‰å¾…ç»§ç»­æ”¹å–„ï¼š

* æŒ‰ç…§ Tag æŸ¥çœ‹ï¼ˆé›å½¢å€’æ˜¯æ­å»ºå¥½äº†ï¼‰
* æœç´¢
* ä¼˜åŒ– CI/CDï¼ˆç°åœ¨è¿˜æ˜¯æ‰‹å·¥æœ¬åœ°è·‘ï¼Œå‡†å¤‡ç”¨ WebHookï¼Œè®©æœåŠ¡å™¨æ¥ GitHub çš„ WebHookï¼Œçˆ¬å–ï¼Œç„¶å Push å› GitHub ä¸Šé¢ï¼‰

æœ‰ä¸ªé—®é¢˜åº”è¯¥ä¼˜åŒ–ï¼š

* Kotlin çš„ PageGenerator ä»£ç æ··ä¹±

è¯è¯´ï¼Œåœ¨è¿™ä¸‰ä¸ªæœˆå†…ï¼Œç¿»è¯‘+æ ¡å¯¹+åŸåˆ›æ–‡åˆ°äº† 100 ç¯‡å’¯ï¼Œæ’’èŠ±æ’’èŠ±ï¼ŒèŠœæ¹–æ¹–ï½ ğŸ‰ğŸ‰

> æœ€åçš„æœ€åï¼Œç»§ç»­æ¨å¹¿ä¸€ä¸‹ [æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)ï¼Œè¿™æ˜¯ä¸€ä¸ªç¿»è¯‘ä¼˜è´¨äº’è”ç½‘æŠ€æœ¯æ–‡ç« çš„ç¤¾åŒºï¼Œæ–‡ç« æ¥æºä¸º æ˜é‡‘ ä¸Šçš„è‹±æ–‡åˆ†äº«æ–‡ç« ã€‚å†…å®¹è¦†ç›–åŒºå—é“¾ã€äººå·¥æ™ºèƒ½ã€Androidã€iOSã€å‰ç«¯ã€åç«¯ã€è®¾è®¡ã€äº§å“ã€ç®—æ³•å’Œå…¶ä»–ç­‰é¢†åŸŸï¼Œä»¥åŠå„å¤§å‹ä¼˜è´¨ å®˜æ–¹æ–‡æ¡£åŠæ‰‹å†Œï¼Œè¯»è€…ä¸ºçƒ­çˆ±æ–°æŠ€æœ¯çš„æ–°é”å¼€å‘è€…ã€‚
> 
> æ˜é‡‘ç¿»è¯‘è®¡åˆ’ç›®å‰ç¿»è¯‘å®Œæˆ 2345 ä½™ç¯‡æ–‡ç« ï¼Œå®˜æ–¹æ–‡æ¡£åŠæ‰‹å†Œ 13 ä¸ªï¼Œå…±æœ‰ 1000 ä½™åè¯‘è€…è´¡çŒ®ç¿»è¯‘å’Œæ ¡å¯¹ã€‚
> 
> æ¬¢è¿å„ä½åŠ å…¥æˆ‘ä»¬å—·ï¼

* æœ¬æ–‡æ­£åœ¨å‚ä¸ã€Œæ˜é‡‘ 2021 æ˜¥æ‹›é—¯å…³æ´»åŠ¨ã€, ç‚¹å‡»æŸ¥çœ‹ [æ´»åŠ¨è¯¦æƒ…](https://juejin.cn/post/6939329638506168334)