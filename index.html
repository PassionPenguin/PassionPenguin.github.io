<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PassionPenguin</title>
    <link rel="stylesheet" href="./assets/styles/atom-one-light.css">
    <link rel="stylesheet" href="./assets/styles/styles.css">
</head>
<body>
<div id="pg-app">
    <div class="leftpane">
        <div id="selectors">

        </div>
    </div>
    <div class="rightpane">
        <div id="content">

        </div>
    </div>
</div>
</body>
<script src="./assets/scripts/highlight.pack.js"></script>
<script>
    const $ = (e) => {
        return document.querySelectorAll(e)
    };
    const Int = (val) => {
        return parseInt(val);
    };
    const Float = (val) => {
        return parseFloat(val);
    };
    const cE = (data) => {
        if (data === undefined)
            data = {tagName: "div", attr: [], innerText: undefined, innerHTML: undefined, onclick: undefined}
        let e = document.createElement(data.tagName);
        if (data.attr !== undefined)
            data.attr.forEach((attr) => {
                e.setAttribute(attr[0], attr[1]);
            });
        if (data.innerText !== undefined)
            e.innerText = data.innerText;
        if (data.innerHTML !== undefined)
            e.innerHTML = data.innerHTML;
        if (data.onclick !== undefined)
            e.onclick = () => {
                data.onclick()
            };
        return e;
    };
    const $_GET = (url) => {
        url = url || window.location.href;
        let result = [],
            tmp = [];
        url.substr(url.indexOf("?"))
            .substr(1)
            .split("&")
            .forEach(function (item) {
                tmp = item.split("=");
                result[decodeURIComponent(tmp[0])] = decodeURIComponent(tmp[1]);
            });
        return result;
    };
    const zoomImage = (src) => {
        let removeZoomImage = () => {
            document.body.removeChild(imageUtilWrap);
            document.body.removeChild(bottomZoomImageUtilCtrlWrap);
            document.body.removeChild($("#pg-filter-zoomFilter")[0]);
            document.body.removeChild($("#zoomImage")[0]);
            $("#pg-app")[0].style.filter = "none";
        }
        document.body.append(cE({
            tagName: "div",
            attr: [["style", "width:200%;height:200%;position:fixed;left:0;top:0;z-index:1000;background:var(--black500);left:0;top:0;"], ["id", "pg-filter-zoomFilter"]],
            onclick: () => {
                removeZoomImage()
            }
        }));
        $("#pg-app")[0].style.filter = "blur(10px)";
        document.body.append(cE({
            tagName: "img",
            attr: [["src", src], ["style", "position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:100%;max-width:100%;max-height:100%;z-index:1000;user-select:none;"], ["id", "zoomImage"]]
        }));
        let imageUtilWrap = cE({
            tagName: "div",
            attr: [["style", "position:fixed;top:0;left:0;width:100%;height:48px;z-index:1002;background:var(--white);"], ["id", "zoomImageUtilWrap"]]
        });
        imageUtilWrap.append(cE({
            tagName: "div",
            attr: [["class", "mi"], ["style", "display: inline-block;position: absolute;left: 20px;top: 50%;transform: translate(0, -50%);user-select:none;"]],
            onclick: () => {
                removeZoomImage()
            }, innerText: "chevron_left"
        }));
        imageUtilWrap.append(cE({
            tagName: "div",
            attr: [["class", "mi"], ["style", "display: inline-block;position: absolute;right: 20px;top: 50%;transform: translate(0, -50%);"]],
            onclick: () => {
                cE({
                    tagName: "a",
                    attr: [["download", src.substring(src.lastIndexOf("/") + 1)], ["href", src]]
                }).click();
            },
            innerText: "save"
        }));
        imageUtilWrap.append(cE({
            tagName: "div",
            attr: [["style", "display: inline-block;position: absolute;left: 50%;top: 50%;transform: translate(-50%, -50%);z-index:1002;font: 15px/1 Anodina,sans-serif;user-select:none;"]],
            onclick: () => {
                removeZoomImage()
            },
            innerText: src.substring(src.lastIndexOf("/") + 1).length > 25 ? src.substring(src.lastIndexOf("/") + 1).substring(0, 10) + "..." + src.substring(src.lastIndexOf("/") + 1).substring(src.substring(src.lastIndexOf("/") + 1).length - 10) : src.substring(src.lastIndexOf("/") + 1)
        }));
        document.body.append(imageUtilWrap);
        let bottomZoomImageUtilCtrlWrap = cE({
            tagName: "div",
            attr: [["style", "position:fixed;left:0;bottom:0;width:100%;height:48px;font-size:0;background:var(--white);z-index:1001;user-select:none;"]]
        })
        bottomZoomImageUtilCtrlWrap.append(cE({
            tagName: "div",
            attr: [["style", "display:inline-block;width:25%;text-align:center;vertical-align:middle;"]],
            innerHTML: "<span class='mi' style='line-height: 48px'>rotate_left</span>",
            onclick: () => {
                if ($("#zoomImage")[0].style.transform.includes("rotate")) {
                    let degree = Int($("#zoomImage")[0].style.transform.match(/\d+deg/)[0].replace(/deg/, ""));
                    $("#zoomImage")[0].style.transform = $("#zoomImage")[0].style.transform.replace(/rotate\(\d+deg\)/, "rotate(") + (degree - 90 < 0 ? degree + 270 : degree - 90).toString() + "deg)";
                } else
                    $("#zoomImage")[0].style.transform += "rotate(270deg)";
            }
        }));
        let scale_big = () => {
            if ($("#zoomImage")[0].style.transform.includes("scale")) {
                let degree = parseFloat($("#zoomImage")[0].style.transform.match(/scale\([-+]?[0-9]*\.?[0-9]*/)[0].replace(/scale\(/, ""));
                if (degree + 0.25 >= 1.75) {
                    scaleBig.onclick = () => {
                    };
                    scaleBig.children[0].style.color = "var(--grey)";
                }
                if (degree >= 0.25) {
                    scaleSmall.children[0].style.color = "var(--black)";
                    scaleSmall.onclick = () => {
                        scale_small()
                    }
                }
                $("#zoomImage")[0].style.transform = $("#zoomImage")[0].style.transform.replace(/scale\([-+]?[0-9]*\.?[0-9]*\)/, "scale(") + (degree + 0.25).toString() + ")";
            } else
                $("#zoomImage")[0].style.transform += "scale(1.25)";
        }
        let scaleBig = cE({
            tagName: "div",
            attr: [["style", "display:inline-block;width:25%;text-align:center;vertical-align:middle;"]],
            innerHTML: "<span class='mi' style='line-height: 48px'>add</span>",
            onclick: () => {
                scale_big();
            }
        });
        bottomZoomImageUtilCtrlWrap.append(scaleBig);
        let scale_small = () => {
            if ($("#zoomImage")[0].style.transform.includes("scale")) {
                let degree = parseFloat($("#zoomImage")[0].style.transform.match(/scale\([-+]?[0-9]*\.?[0-9]*/)[0].replace(/scale\(/, ""));
                if (degree - 0.25 <= 0.25) {
                    scaleSmall.onclick = () => {
                    };
                    scaleSmall.children[0].style.color = "var(--grey)";
                }
                if (degree <= 1.75) {
                    scaleBig.children[0].style.color = "var(--black)";
                    scaleBig.onclick = () => {
                        scale_big()
                    }
                }
                $("#zoomImage")[0].style.transform = $("#zoomImage")[0].style.transform.replace(/scale\([-+]?[0-9]*\.?[0-9]*\)/, "scale(") + (degree - 0.25).toString() + ")";
            } else
                $("#zoomImage")[0].style.transform += "scale(0.75)";
        }
        let scaleSmall = cE({
            tagName: "div",
            attr: [["style", "display:inline-block;width:25%;text-align:center;vertical-align:middle;"]],
            innerHTML: "<span class='mi' style='line-height: 48px'>remove</span>",
            onclick: () => {
                scale_small();
            }
        });
        bottomZoomImageUtilCtrlWrap.append(scaleSmall);
        bottomZoomImageUtilCtrlWrap.append(cE({
            tagName: "div",
            attr: [["style", "display:inline-block;width:25%;text-align:center;vertical-align:middle;"]],
            innerHTML: "<span class='mi' style='line-height: 48px'>rotate_right</span>",
            onclick: () => {
                if ($("#zoomImage")[0].style.transform.includes("rotate")) {
                    let degree = Int($("#zoomImage")[0].style.transform.match(/\d+deg/)[0].replace(/deg/, ""));
                    $("#zoomImage")[0].style.transform = $("#zoomImage")[0].style.transform.replace(/rotate\(\d+deg\)/, "rotate(") + (degree - 90 > 360 ? degree - 270 : degree + 90).toString() + "deg)";
                } else
                    $("#zoomImage")[0].style.transform += "rotate(90deg)";
            }
        }));
        document.body.append(bottomZoomImageUtilCtrlWrap)
    };
    const loadList = () => {
        (async () => {
            history.pushState({"mod": "viewlist"}, "Main Page", "?mod=viewlist")

            const data = await fetch("./articles.json");
            const articleContents = await data.json();

            articleContents.forEach((article) => {
                contentArea.appendChild(cE({
                    tagName: "div", attr: [["class", "pg-content-articleListContent"]],
                    innerHTML: "<h3 class='articleListTitle'>" + article.title + " <small>" + article.author + "</small></h3><small class='timeString'>" + new Date(Int(article.postTime)).toLocaleString("zh-CN", {timeZone: "Asia/Hong_Kong"}) + "</small></h3><p>" + article.shortDescription + "</p><img src='" + article.imgSrc + "' alt='" + article.imgDescription + "' />",
                    onclick: () => {
                        history.pushState({
                            "mod": "viewpost",
                            "postid": article.articleid
                        }, article.title, "?mod=viewpost&postid=" + article.articleid)
                        contentArea.innerHTML = "";
                        loadPost();
                    }
                }));
            });
        })();
    }
    const loadPost = () => {

        (async () => {
            let postid = null;
            if (history.state === null) postid = $_GET()["postid"]
            else postid = history.state.postid;
            history.pushState({
                "mod": "viewpost",
                "postid": postid
            }, "Main Page", "?mod=viewpost&postid=" + $_GET()['postid'])

            const data = await fetch("./assets/data/article." + $_GET()['postid'] + ".json");
            const article = await data.json();

            contentArea.appendChild(cE({
                tagName: "img",
                attr: [["class", "pg-img-headbanner"], ["src", "./assets/media/images/" + article.imgSrc], ["alt", article.imgDescription]]
            }));
            contentArea.appendChild(cE({
                tagName: "h2",
                attr: [["class", "pg-title-header"]],
                innerText: article.title
            }));
            contentArea.appendChild(cE({
                tagName: "p",
                attr: [["class", "pg-post-metainfo"]],
                innerText: article.author + " - " + new Date(Int(article.postTime)).toLocaleString("zh-CN", {timeZone: "Asia/Hong_Kong"})
            }));
            article.content.forEach(e => {
                if (e.type === "img")
                    contentArea.appendChild(cE({
                        tagName: "img",
                        attr: [["class", "pg-img-contentImage"], ["src", "./assets/media/images/" + e.imgSrc], ["alt", e.imgDescription]],
                        onclick: () => {
                            zoomImage("./assets/media/images/" + e.imgSrc);
                        }
                    }));
                else if (e.type === "expandable") {
                    let container = cE({
                        tagName: "div",
                        attr: [["class", "pg-app-plugin-expand"]],
                    });
                    let chooser = cE({
                        tagName: "div",
                        attr: [["class", "pg-app-plugin-expand-topSelector"]]
                    });
                    let contentContainer = cE({
                        tagName: "div",
                        attr: [["class", "pg-app-plugin-expand-contentContainer"]]
                    });
                    container.appendChild(chooser);
                    container.appendChild(contentContainer);
                    e.choose.forEach((i, index) => {
                        chooser.appendChild(cE({
                            tagName: "span",
                            attr: [["class", "pg-app-plugin-expand-selector"]],
                            innerText: i, onclick: () => {
                                container.querySelectorAll("*.active").forEach(j => {
                                    j.classList.remove("active")
                                });
                                contentContainer.children[index].classList.add("active");
                                chooser.children[index].classList.add("active");
                            }
                        }));
                    });
                    e.innerHTML.forEach(i => {
                        contentContainer.appendChild(cE({
                            tagName: "p",
                            attr: [["class", "pg-app-plugin-expand-content"]],
                            innerHTML: i
                        }));
                    });
                    contentContainer.children[0].classList.add("active");
                    chooser.children[0].classList.add("active");
                    contentArea.appendChild(container);
                } else if (e.type === "subtitle")
                    contentArea.appendChild(cE({
                        tagName: "h4",
                        attr: [["class", "pg-content-subtitle"], ["id", e.id]], innerHTML: e.innerHTML
                    })); else
                    contentArea.appendChild(cE({
                        tagName: "p",
                        attr: [["class", "pg-content"], e.id !== undefined ? ["id", e.id] : ["id", ""]],
                        innerHTML: e.innerHTML
                    }));
            });
            hljs.initHighlighting();

            [...$("a[href^='#']")].forEach(e => {
                let href = e.getAttribute("href");
                e.onclick = (i) => {
                    i.preventDefault();
                    const tag = $(href)[0].offsetTop;
                    const cur = $("#pg-app")[0].scrollTop;
                    console.log(tag, cur);
                    const diff = cur - tag + 512;
                    let k = 0;
                    const dif = Math.abs(diff) / 25;
                    let interval = setInterval(() => {
                        if (k > 25)
                            clearInterval(interval);
                        if (diff > 0)
                            $("#pg-app")[0].scrollTop = $("#pg-app")[0].scrollTop - dif;
                        else
                            $("#pg-app")[0].scrollTop = $("#pg-app")[0].scrollTop + dif;
                        k++;
                    }, 4);
                    e.setAttribute("href", "javascript:;");
                }
            });
        })();
    }
    window.onload = window.onpopstate = () => {
        window.contentArea = $("#content")[0];
        contentArea.innerHTML = "";

        if ($_GET()["mod"] === "viewpost")
            loadPost();
        else
            loadList();
    }
</script>
</html>